"use strict";var z=Object.create;var x=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var B=(r,o)=>{for(var a in o)x(r,a,{get:o[a],enumerable:!0})},D=(r,o,a,c)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of L(o))!H.call(r,i)&&i!==a&&x(r,i,{get:()=>o[i],enumerable:!(c=O(o,i))||c.enumerable});return r};var M=(r,o,a)=>(a=r!=null?z(G(r)):{},D(o||!r||!r.__esModule?x(a,"default",{value:r,enumerable:!0}):a,r)),E=r=>D(x({},"__esModule",{value:!0}),r);var ne={};B(ne,{Component:()=>V,devicePlugin:()=>W});module.exports=E(ne);var l=require("flipper-plugin");var d=require("flipper"),q=M(require("react")),Z={thermal_zone:"flex",temperature:"flex",path:"flex"},j={thermal_zone:{value:"Thermal Zone",resizable:!0},temperature:{value:"Temperature",resizable:!0},path:{value:"Path",resizable:!0}},v=class extends d.Component{constructor(){super(...arguments);this.buildRow=(a,c)=>({columns:{thermal_zone:{value:q.default.createElement(d.Text,null,a)},temperature:{value:q.default.createElement(d.Text,null,c.temp.toString())},path:{value:q.default.createElement(d.Text,null,c.path)}},key:a});this.buildRows=()=>{let a=[];for(let c of Object.keys(this.props.temperatureMap).sort())a.push(this.buildRow(c,this.props.temperatureMap[c]));return a}}render(){return q.default.createElement(d.SearchableTable,{multiline:!0,autoHeight:!0,floating:!1,zebra:!0,columnSizes:Z,columns:j,rows:this.buildRows(),grow:!0})}};var g=require("antd"),P=require("@ant-design/icons"),s=M(require("react"));function K(r){let o=Math.floor(Number(r));return String(o)===r&&o>=0}function h(r){return r==-1?"N/A":r==-2?"off":r>1e3*1e3?(r/1e3/1e3).toFixed(2)+" GHz":r/1e3+" MHz"}function W(r){let o=r.device,a=async e=>o.executeShell(e),c=null,i=(0,l.createState)({cpuCount:0,cpuFreq:[],monitoring:!1,hardwareInfo:"",temperatureMap:{},thermalAccessible:!0,displayThermalInfo:!1,displayCPUDetail:!0}),p=async(e,n)=>{let t=await a("cat /sys/devices/system/cpu/cpu"+e+"/cpufreq/"+n);i.update(u=>{let m=K(t)?parseInt(t,10):-1;u.cpuFreq[e][n]!=m&&(u.cpuFreq[e][n]=m,n=="scaling_cur_freq"&&u.cpuFreq[e][n]<0&&(u.cpuFreq[e][n]=-2))})},y=async e=>{let n=await a("cat /sys/devices/system/cpu/cpu"+e+"/cpufreq/scaling_available_frequencies");i.update(t=>{let u=n.split(" ").map(_=>parseInt(_,10));t.cpuFreq[e].scaling_available_freqs=u;let m=t.cpuFreq[e].scaling_max_freq;m>0&&u.indexOf(m)==-1&&u.push(m)})},S=async e=>{let n=await a("cat /sys/devices/system/cpu/cpu"+e+"/cpufreq/scaling_governor");i.update(t=>{n.toLowerCase().includes("no such file")?t.cpuFreq[e].scaling_governor="N/A":t.cpuFreq[e].scaling_governor=n})},w=async e=>(await a("cat /sys/devices/system/cpu/cpu"+e+"/cpufreq/scaling_available_governors")).split(" "),F=async e=>{let n=i.get().cpuFreq[e],t=[];return n.cpuinfo_max_freq<0&&t.push(p(e,"cpuinfo_max_freq")),n.cpuinfo_min_freq<0&&t.push(p(e,"cpuinfo_min_freq")),t.push(p(e,"scaling_cur_freq")),t.push(p(e,"scaling_min_freq")),t.push(p(e,"scaling_max_freq")),Promise.all(t).then(()=>{})},U=async()=>{let e=await a("getprop ro.board.platform"),n="";if(e.startsWith("msm")||e.startsWith("apq")||e.startsWith("sdm"))n="QUALCOMM "+e.toUpperCase();else if(e.startsWith("exynos")){let t=await a("getprop ro.chipname");t!=null&&i.update(u=>{u.hardwareInfo="SAMSUMG "+t.toUpperCase()});return}else e.startsWith("mt")?n="MEDIATEK "+e.toUpperCase():e.startsWith("sc")?n="SPREADTRUM "+e.toUpperCase():e.startsWith("hi")||e.startsWith("kirin")?n="HISILICON "+e.toUpperCase():e.startsWith("rk")?n="ROCKCHIP "+e.toUpperCase():e.startsWith("bcm")&&(n="BROADCOM "+e.toUpperCase());i.update(t=>{t.hardwareInfo=n})},C=async()=>{let e="/sys/class/thermal/",n={},t=await a("ls "+e);if(t.toLowerCase().includes("permission denied")){i.update(_=>{_.thermalAccessible=!1});return}let u=t.split(/\s/),m=[];for(let _ of u){if(_=_.trim(),_.length==0)continue;let N=e+_;m.push(f(N,_,n))}await Promise.all(m),i.update(_=>{_.temperatureMap=n,_.thermalAccessible=!0}),i.get().displayThermalInfo&&setTimeout(C,1e3)},f=async(e,n,t)=>{let u=await a("cat "+e+"/type");if(u.length==0)return;let m=await a("cat "+e+"/temp");Number.isNaN(Number(m))||(t[u]={path:n,temp:parseInt(m,10)})},T=()=>{if(i.get().monitoring)return;i.update(n=>{n.monitoring=!0});for(let n=0;n<i.get().cpuCount;++n)w(n).then(t=>{i.update(u=>{u.cpuFreq[n].scaling_available_governors=t})}).catch(t=>{console.error("Failed to read CPU governors:",t)});let e=async()=>{if(!i.get().monitoring)return;let n=[];for(let t=0;t<i.get().cpuCount;++t)n.push(F(t)),n.push(S(t)),n.push(y(t));await Promise.all(n),c=setTimeout(e,500)};c=setTimeout(e,500)},b=()=>{c&&clearInterval(c),c=null,i.update(e=>{e.monitoring=!1})},I=()=>{b(),i.update(e=>{for(let n=0;n<e.cpuCount;++n)e.cpuFreq[n].scaling_cur_freq=-1,e.cpuFreq[n].scaling_min_freq=-1,e.cpuFreq[n].scaling_max_freq=-1,e.cpuFreq[n].scaling_available_freqs=[],e.cpuFreq[n].scaling_governor="N/A"})},k=()=>{i.get().displayThermalInfo||C(),i.update(e=>{e.displayThermalInfo=!e.displayThermalInfo,e.displayCPUDetail=!1})},A=()=>{i.update(e=>{e.displayCPUDetail=!e.displayCPUDetail,e.displayThermalInfo=!1})};return a("cat /sys/devices/system/cpu/possible").then(e=>{let n=e.indexOf("-"),t=[],u=parseInt(e.substring(n+1),10)+1;for(let m=0;m<u;++m)t[m]={cpu_id:m,scaling_cur_freq:-1,scaling_min_freq:-1,scaling_max_freq:-1,cpuinfo_min_freq:-1,cpuinfo_max_freq:-1,scaling_available_freqs:[],scaling_governor:"N/A",scaling_available_governors:[]};i.set({cpuCount:u,cpuFreq:t,monitoring:!1,hardwareInfo:"",temperatureMap:{},thermalAccessible:!0,displayThermalInfo:!1,displayCPUDetail:!0})}).catch(e=>{console.error("Failed to read CPU cores:",e)}),r.onDeactivate(()=>I()),r.onActivate(()=>{U(),C()}),{executeShell:a,cpuState:i,onStartMonitor:T,onStopMonitor:b,toggleCPUSidebar:A,toggleThermalSidebar:k}}var J=[{key:"cpu_id",title:"CPU ID"},{key:"scaling_cur_freq",title:"Current Frequency"},{key:"scaling_min_freq",title:"Scaling min"},{key:"scaling_max_freq",title:"Scaling max"},{key:"cpuinfo_min_freq",title:"CPU min"},{key:"cpuinfo_max_freq",title:"CPU max"},{key:"scaling_governor",title:"Scaling governor"}],Q=[{key:"key",title:"key",wrap:!0},{key:"value",title:"value",wrap:!0}];function V(){let r=(0,l.usePlugin)(W),{onStartMonitor:o,onStopMonitor:a,toggleCPUSidebar:c,toggleThermalSidebar:i}=r,p=(0,l.useValue)(r.cpuState),[y,S]=(0,s.useState)([]),w=f=>{let T="Scaling Available Frequencies",b=p.cpuFreq[f];b.scaling_available_freqs.length>0&&(T+=" ("+b.scaling_available_freqs.length.toString()+")");let I=[T,"Scaling Available Governors"],k=[re(b),$(b)];return I.map((A,e)=>X(A,k[e]))},F=()=>{if(!p.displayCPUDetail||y.length==0)return null;let f=y[0];return s.default.createElement(l.DetailSidebar,{width:500},s.default.createElement(l.Layout.Container,{pad:!0},s.default.createElement(g.Typography.Title,null,"CPU Details: CPU_",f),s.default.createElement(l.DataTable,{records:w(f),columns:Q,scrollable:!1,enableSearchbar:!1})))},U=()=>p.displayThermalInfo?s.default.createElement(l.DetailSidebar,{width:500},s.default.createElement(l.Panel,{pad:l.theme.space.small,title:"Thermal Information",collapsible:!1},p.thermalAccessible?s.default.createElement(v,{temperatureMap:p.temperatureMap}):"Temperature information not accessible on this device.")):null,C=(0,s.useCallback)(f=>{S(f?[f.core]:[])},[]);return s.default.createElement(l.Layout.Container,{pad:!0},s.default.createElement(g.Typography.Title,null,"CPU Info"),s.default.createElement(l.Toolbar,null,p.monitoring?s.default.createElement(g.Button,{onClick:a,icon:s.default.createElement(P.PauseCircleOutlined,null)},"Pause"):s.default.createElement(g.Button,{onClick:o,icon:s.default.createElement(P.PlayCircleOutlined,null)},"Start"),"\xA0 ",p.hardwareInfo,s.default.createElement(g.Switch,{checked:p.displayThermalInfo,onClick:i}),"Thermal Information",s.default.createElement(g.Switch,{onClick:c,checked:p.displayCPUDetail}),"CPU Details",p.displayCPUDetail&&y.length==0&&" (Please select a core in the table below)"),s.default.createElement(l.DataTable,{records:R(p.cpuFreq),columns:J,scrollable:!1,onSelect:C,onRowStyle:ee,enableSearchbar:!1}),F(),U())}function $(r){return r.scaling_available_governors.length==0?"N/A":r.scaling_available_governors.join(", ")}function X(r,o){return{key:r,value:o}}function Y(r){return{core:r.cpu_id,cpu_id:`CPU_${r.cpu_id}`,scaling_cur_freq:h(r.scaling_cur_freq),scaling_min_freq:h(r.scaling_min_freq),scaling_max_freq:h(r.scaling_max_freq),cpuinfo_min_freq:h(r.cpuinfo_min_freq),cpuinfo_max_freq:h(r.cpuinfo_max_freq),scaling_governor:r.scaling_governor}}function R(r){return r.map(Y)}function ee(r){if(r.scaling_cur_freq==-2)return{backgroundColor:l.theme.backgroundWash,color:l.theme.textColorPrimary,fontWeight:700};if(r.scaling_min_freq!=r.cpuinfo_min_freq&&r.scaling_min_freq>0&&r.cpuinfo_min_freq>0)return{backgroundColor:l.theme.warningColor,color:l.theme.textColorPrimary,fontWeight:700};if(r.scaling_max_freq!=r.cpuinfo_max_freq&&r.scaling_max_freq>0&&r.cpuinfo_max_freq>0)return{backgroundColor:l.theme.backgroundWash,color:l.theme.textColorSecondary,fontWeight:700}}function re(r){if(r.scaling_available_freqs.length==0)return s.default.createElement(g.Typography.Text,null,"N/A");let o=r;return s.default.createElement(g.Typography.Text,null,r.scaling_available_freqs.map((a,c)=>{let i=a==o.scaling_cur_freq||a==o.scaling_min_freq||a==o.scaling_max_freq;return s.default.createElement(g.Typography.Text,{key:c,strong:i},h(a),a==o.scaling_cur_freq&&s.default.createElement(g.Typography.Text,{strong:i}," ","(scaling current)"),a==o.scaling_min_freq&&s.default.createElement(g.Typography.Text,{strong:i}," (scaling min)"),a==o.scaling_max_freq&&s.default.createElement(g.Typography.Text,{strong:i}," (scaling max)"),s.default.createElement("br",null))}))}
