"use strict";var M=Object.create;var E=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var P=(n,i)=>{for(var e in i)E(n,e,{get:i[e],enumerable:!0})},L=(n,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let l of T(i))!A.call(n,l)&&l!==e&&E(n,l,{get:()=>i[l],enumerable:!(s=N(i,l))||s.enumerable});return n};var W=(n,i,e)=>(e=n!=null?M(D(n)):{},L(i||!n||!n.__esModule?E(e,"default",{value:n,enumerable:!0}):e,n)),O=n=>L(E({},"__esModule",{value:!0}),n);var v={};P(v,{default:()=>b});module.exports=O(v);var d=W(require("react")),a=require("flipper");function y(n,i,e){let s=e.get(i);s&&s.children&&s.children.push(n)}function f(n,i=!1){let e={};for(let[s,l]of n.entries())i&&l instanceof Map&&(l=f(l,!0)),e[String(s)]=l;return e}function z(n,i){let e=n.match(/\* (GC ROOT )?(\u21B3 )?([a-z]* )?([^A-Z]*.)?([A-Z].*)/),s="N/A";return e&&(s=e[5]),{id:i,name:s,expanded:!0,children:[],attributes:[],data:{},decoration:"",extraInfo:{}}}var x="* Details:",V="* Excluded Refs:",B="static ",G="has leaked:",F="* Retaining: ";function Z(n,i){let e=new Map,s=new Map,l=new Map,o=new Map,t=-1,r="",m=new Map;for(;i<n.length&&!n[i].startsWith(V);){let g=n[i];if(g.startsWith("*")){t!=-1&&(e.set(r,l),s.set(r,o),l=new Map,o=new Map),t++,r=String(t);let c="unknown",p=g.match(/\* (.*)(of|Class) (.*)/);p&&(c=p[3]),m.set(r,c)}else{let c=g.match(/\|\s+(.*) = (.*)/);if(c){let p=c[1],k=c[2];if(p.startsWith(B)){let I=p.substr(7);l.set(I,k)}else o.set(p,k)}}i++}return e.set(r,l),s.set(r,o),{staticFields:e,instanceFields:s,packages:m}}function j(n,i){let e=i.split(`
`),s=new Map,l=new Map,o="",t=0;for(;t<e.length&&!e[t].endsWith(G);)t++;if(t++,t>=e.length)return n;let r=0,m=String(r),g="";for(;t<e.length&&e[t].startsWith("*");){let u=e[t],S=String(r-1);r!==0?(y(m,S,s),y(m,S,l)):o=m;let h=z(u,m);g=h.name,s.set(m,h),l.set(m,h),t++,r++,m=String(r)}for(;t<e.length&&!e[t].startsWith(F)&&!e[t].startsWith(x);)t++;let c="unknown size";if(e[t].startsWith(F)){let u=e[t].match(/\* Retaining: (.*)./);u&&(c=u[1])}for(;t<e.length&&!e[t].startsWith(x);)t++;t++;let{staticFields:p,instanceFields:k,packages:I}=Z(e,t);for(let[u,S]of I.entries()){let h=s.get(u);if(!h)continue;let w=h.name.match(/([^\. ]*)(.*)/);w&&w.length===3&&(h.name=S+w[2])}return n.push({title:g,root:o,elements:f(s),elementsSimple:f(l),staticFields:f(p,!0),instanceFields:f(k,!0),retainedSize:c}),n}function C(n){return n.reduce(j,[])}var R=(0,a.styled)(a.FlexRow)({height:"100%",flex:1}),_=(0,a.styled)(a.FlexRow)({alignItems:"center",marginLeft:"8px"}),b=class extends a.FlipperPlugin{constructor(){super(...arguments);this.state={leaks:[],selectedIdx:null,selectedEid:null,showFullClassPaths:!1,leaksCount:0};this._addNewLeaks=e=>{let s=e.slice(this.state.leaksCount),l=this.state.leaks;for(let o=0;o<s.length;o++)l.push(s[o]);this.setState({leaks:l,leaksCount:l.length})};this._adaptLeak2=e=>({title:e.title,root:e.root,elements:e.elements,elementsSimple:e.elements,staticFields:{},instanceFields:{},retainedSize:e.retainedSize,details:e.details});this._clearLeaks=()=>{this.setState({leaks:[],leaksCount:0,selectedIdx:null,selectedEid:null}),this.client.call("clear").catch(e=>{console.warn("[LeakCanary] clear failed with error",e)})};this._selectElement=(e,s)=>{this.setState({selectedIdx:e,selectedEid:s})};this._toggleElement=(e,s)=>{let{leaks:l}=this.state,o=l[e],t=o.elements[s],r=o.elementsSimple[s];!t||!r||(t.expanded=!t.expanded,r.expanded=!r.expanded,this.setState({leaks:l}))}}init(){this.client.subscribe("reportLeak",e=>{this._addNewLeaks(C(e.leaks))}),this.client.subscribe("reportLeak2",e=>{this._addNewLeaks(e.leaks.map(this._adaptLeak2))})}_extractValue(e,s){if(isNaN(e)){if(e=="true"||e=="false")return{mutable:!1,type:"boolean",value:e};if(e=="null")return{mutable:!1,type:"null",value:e}}else return{mutable:!1,type:"number",value:e};return{mutable:!1,type:"enum",value:e}}renderSidebar(){let{selectedIdx:e,selectedEid:s,leaks:l}=this.state;if(e==null||s==null)return null;let o=l[e],t=o.staticFields[s],r=o.instanceFields[s];return d.default.createElement(a.Sidebar,{position:"right",width:600,minWidth:300,maxWidth:900},r&&d.default.createElement(a.Panel,{heading:"Instance",floating:!1,grow:!1},d.default.createElement(a.ManagedDataInspector,{data:r,expandRoot:!0,extractValue:this._extractValue})),t&&d.default.createElement(a.Panel,{heading:"Static",floating:!1,grow:!1},d.default.createElement(a.ManagedDataInspector,{data:t,expandRoot:!0,extractValue:this._extractValue})),o.details&&d.default.createElement(a.Panel,{heading:"Details",floating:!1,grow:!1},d.default.createElement("pre",null,o.details)))}render(){let{selectedIdx:e,selectedEid:s,showFullClassPaths:l}=this.state,o=this.renderSidebar();return d.default.createElement(R,null,d.default.createElement(a.FlexColumn,{grow:!0},d.default.createElement(a.FlexColumn,{grow:!0,scrollable:!0},this.state.leaks.map((t,r)=>{let m=l?t.elements:t.elementsSimple,g=e==r?s:null;return d.default.createElement(a.Panel,{key:r,collapsable:!0,padded:!1,heading:t.title,floating:!0,accessory:t.retainedSize},d.default.createElement(a.ElementsInspector,{onElementSelected:c=>{this._selectElement(r,c)},onElementHovered:()=>{},onElementExpanded:c=>{this._toggleElement(r,c)},selected:g,searchResults:null,root:t.root,elements:m,scrollable:!1}))})),d.default.createElement(a.Toolbar,null,d.default.createElement(_,null,d.default.createElement(a.Button,{onClick:this._clearLeaks},"Clear")),d.default.createElement(_,null,d.default.createElement(a.Checkbox,{checked:l,onChange:t=>{this.setState({showFullClassPaths:t})}}),"Show full class path"))),o)}};
